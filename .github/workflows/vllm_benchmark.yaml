name: vLLM Benchmark Workflow


on:
  pull_request:
    branches:
      - dev/perf
  schedule:
    # 0 15 * * * means every day at 15:00 UTC, which is 23:00 Beijing time.
    - cron: '0 15 * * *'
  workflow_dispatch:
    inputs:
      vllm_repo:
        description: 'vLLM repo (default: https://github.com/ROCm/vllm.git)'
        required: false
        default: 'https://github.com/ROCm/vllm.git'
      aiter_repo:
        description: 'Aiter repo (default: https://github.com/ROCm/aiter.git)'
        required: false
        default: 'https://github.com/ROCm/aiter.git'
      vllm_branch:
        description: 'vLLM branch or commit (default: latest dev/perf)'
        required: false
        default: 'dev/perf'
      aiter_branch:
        description: 'Aiter branch or commit (default: latest dev/perf)'
        required: false
        default: 'dev/perf'
      deepseekr1_ptpc_fp8:
        description: 'DeepSeek R1 PTPC FP8 model'
        required: true
        type: boolean
        default: true
      deepseekr1:
        description: 'DeepSeek R1 model'
        required: true
        type: boolean
        default: false
      qwen3coder_ptpc_fp8:
        description: 'Qwen3Coder PTPC FP8 model'
        required: true
        type: boolean
        default: false
      qwen3next:
        description: 'Qwen3Next model'
        required: true
        type: boolean
        default: false

env:
  BASE_IMAGE: "rocm/vllm-dev:nightly"
  AITER_REPO: ${{ github.event.inputs.aiter_repo || 'https://github.com/ROCm/aiter.git' }}
  AITER_BRANCH: ${{ github.event.inputs.aiter_branch || 'dev/perf' }}
  vLLM_REPO: ${{ github.event.inputs.vllm_repo || 'https://github.com/ROCm/vllm.git' }}
  vLLM_BRANCH: ${{ github.event.inputs.vllm_branch || 'dev/perf' }}

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build-and-test:
    strategy:
      matrix:
        include:
          - model: deepseekr1_ptpc_fp8
            enabled: ${{ github.event_name == 'pull_request' || github.event.inputs.deepseekr1_ptpc_fp8 == 'true' || github.event_name == 'schedule' }}
          - model: deepseekr1
            enabled: ${{ github.event.inputs.deepseekr1 == 'true' || github.event_name == 'schedule' }}
          - model: qwen3coder_ptpc_fp8
            enabled: ${{ github.event.inputs.qwen3coder_ptpc_fp8 == 'true' || github.event_name == 'schedule' }}
          - model: qwen3next
            enabled: ${{ github.event.inputs.qwen3next == 'true' || github.event_name == 'schedule' }}
      fail-fast: false
    runs-on: vllm-mi308-8gpu
    steps:
      - name: Checkout vLLM repo
        if: ${{ matrix.enabled }}
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.inputs.vllm_branch }}
          fetch-depth: 0  # ensure getting the latest full code history

      - name: Show disk usage
        if: ${{ matrix.enabled }}
        run: |
          df -h
      
      - name: Show models directory
        if: ${{ matrix.enabled }}
        run: |
          ls -all /models/

      - name: Docker login
        if: ${{ matrix.enabled }}
        run: docker login -u rocmshared -p ${{ secrets.DOCKER_PASSWORD }}

      - name: Download the vLLM base image
        if: ${{ matrix.enabled }}
        run: |
          docker pull ${{ env.BASE_IMAGE }}
      
      - name: Generate Dockerfile
        if: ${{ matrix.enabled }}
        run: |
          cat <<EOF > Dockerfile.mod
          FROM ${{ env.BASE_IMAGE }}

          RUN echo "=== Aiter version BEFORE uninstall ===" && pip show aiter || true
          RUN pip uninstall -y aiter
          RUN pip install --upgrade "pybind11>=3.0.1"
          RUN pip show pybind11

          RUN git clone ${{ env.AITER_REPO }} /aiter && \\
              cd /aiter && \\
              git checkout ${{ env.AITER_BRANCH }} && \\
              git submodule sync && git submodule update --init --recursive && \\
              python3 setup.py develop

          RUN echo "=== Aiter version AFTER installation ===" && pip show aiter || true

          RUN echo "=== vLLM version BEFORE uninstall ===" && pip show vllm || true
          RUN pip uninstall -y vllm

          RUN git clone ${{ env.vLLM_REPO }} /vllm && \\
              cd /vllm && \\
              git checkout ${{ env.vLLM_BRANCH }} && \\
              pip install -U -r requirements/rocm.txt && \\
              python3 setup.py develop

          RUN echo "=== vLLM version AFTER installation ===" && pip show vllm || true
          EOF

      - name: Show Dockerfile
        if: ${{ matrix.enabled }}
        run: cat Dockerfile.mod

      - name: Build Docker image
        if: ${{ matrix.enabled }}
        run: |
          TAG=$(echo "${{ env.vLLM_BRANCH }}-${{ env.AITER_BRANCH }}" | tr '/' '-')
          IMAGE_TAG="rocm/vllm-aiter-ci:$TAG"
          docker build --no-cache -t "$IMAGE_TAG" -f Dockerfile.mod .
          echo "IMAGE_TAG=$IMAGE_TAG" >> "$GITHUB_ENV"
      
      - name: Clean up Rocm processes
        if: ${{ matrix.enabled }}
        run: |
          ./.github/scripts/clean_up_rocm.sh

      - name: Run the container
        if: ${{ matrix.enabled }}
        run: |
          set -ex
          echo "Starting container: vllm_test_${{ matrix.model }}"
          docker run -dt \
          --device=/dev/dri \
          --device=/dev/kfd \
          --device /dev/fuse \
          --cap-add SYS_ADMIN \
          --privileged \
          --shm-size=128G \
          --user root \
          --group-add "$(getent group render | cut -d: -f3)" \
          --group-add "$(getent group video | cut -d: -f3)" \
          -v "${{ github.workspace }}:/workspace" \
          -v /models:/models \
          -w /workspace \
          --name vllm_test_${{ matrix.model }} \
          "${{ env.IMAGE_TAG }}"
      
      - name: Install Denpendencies
        if: ${{ matrix.enabled }}
        run: |
          docker exec vllm_test_${{ matrix.model }} git config --global --add safe.directory /workspace
          docker exec vllm_test_${{ matrix.model }} pip install lm_eval tenacity
          docker exec vllm_test_${{ matrix.model }} apt update
          docker exec vllm_test_${{ matrix.model }} apt install -y jq
          
      - name: Run performance tests
        if: ${{ matrix.enabled }}
        run: |
          echo "Running benchmark for model: ${{ env.MODEL_NAME }}"
          docker exec vllm_test_${{ matrix.model }} ./.github/scripts/benchmark.sh "${{ env.MODEL_NAME }}" "benchmark_results-${{ env.MODEL_NAME }}.json"
      
      - name: Upload benchmark results
        if: ${{ always() }}
        uses: actions/upload-artifact@v4
        continue-on-error: true
        with:
          name: benchmark_results-${{ matrix.model }}-${{ github.run_id }}
          path: models_performance_test/*.json
      
      - name: Upload comparison log
        if: ${{ always() }}
        uses: actions/upload-artifact@v4
        continue-on-error: true
        with:
          name: comparison_log-${{ matrix.model }}-${{ github.run_id }}
          path: comparison-*.log

      - name: Clean up Rocm processes
        if: ${{ matrix.enabled }}
        run: |
          ./.github/scripts/clean_up_rocm.sh
      
      - name: Remove Docker container
        if: ${{ always() }}
        run: |
          docker rm -f vllm_test_${{ matrix.model }} || true

      - name: Mark as skipped
        if: ${{ !matrix.enabled }}
        run: echo "This benchmark was skipped because ${{ matrix.enabled }} is disabled."
