# Copyright (C) 2025 Habana Labs, Ltd. an Intel Company
# SPDX-License-Identifier: Apache-2.0

# Parameterize base image components for SUSE (tested on 15.5)
ARG DOCKER_URL=vault.habana.ai/gaudi-docker
ARG VERSION=1.22.0
ARG BASE_NAME=sles15sp5
ARG PT_VERSION=2.7.1
ARG REVISION=latest
ARG REPO_TYPE=habanalabs

FROM ${DOCKER_URL}/${VERSION}/${BASE_NAME}/${REPO_TYPE}/pytorch-installer-${PT_VERSION}:${REVISION}

# Parameterize commit/branch for vllm-fork checkout
ARG VLLM_FORK_COMMIT=v0.9.0.1+Gaudi-1.22.0

ENV OMPI_MCA_btl_vader_single_copy_mechanism=none

# Install required packages for SUSE
RUN zypper --non-interactive refresh && \
    zypper --non-interactive install gettext jq python3-pip git && \
    ln -sf /usr/bin/python3 /usr/bin/python

WORKDIR /root

ENV VLLM_PATH=/workspace/vllm

# Clone the vllm-fork repository
RUN mkdir -p $VLLM_PATH && \
    git clone https://github.com/HabanaAI/vllm-fork.git $VLLM_PATH && \
    cd $VLLM_PATH && \
    git remote add upstream https://github.com/vllm-project/vllm.git && \
    git fetch upstream --tags || true && \
    git checkout ${VLLM_FORK_COMMIT}

# Install vllm-fork inside the container
ENV VLLM_TARGET_DEVICE=hpu
RUN pip3 install -v -e $VLLM_PATH
RUN pip3 install -v -e $VLLM_PATH/tests/vllm_test_utils

# Install additional Python packages
RUN pip3 install datasets pandas

# Copy utility scripts and configuration
RUN mkdir -p /root/scripts/
COPY templates /root/scripts/templates/
COPY entrypoints /root/scripts/entrypoints/
COPY server /root/scripts/server/
COPY benchmark /root/scripts/benchmark/
WORKDIR /root/scripts

# Set entrypoint script
ENTRYPOINT ["python3", "-m", "entrypoints.entrypoint_main"]